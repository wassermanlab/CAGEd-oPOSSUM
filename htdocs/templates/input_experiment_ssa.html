<script type="text/javascript">

function isblank(s)
{
    for (var i = 0; i < s.length; i++) {
        var c = s.charAt(i);

        if ((c != ' ') && (c != '\n') && (c != '\t'))
            return false;
    }
    return true;
}

function verify(f)
{
    var msg;
    var errors = "";
    var v;

    if (f.tf_select_method[0].checked) {
        v = parseFloat(f.core_min_ic.value);
        if (isNaN(v)) {
            errors += "Minimum specificity for JASPAR CORE profiles is not a valid number\n";
        } else {
            if (v < [%db_info.min_ic%]) {
                errors += "Minimum specificity for JASPAR CORE profiles is below minimum allowable";
                errors += " [%db_info.min_ic%] bits\n";
            }
        }
    } else if (f.tf_select_method[1].checked) {
        var tfs_selected = false;
        for (var i = 0; i < f.core_tfs.options.length; i++) {
            if (f.core_tfs.options[i].selected) {
                tfs_selected = true;
                break;
            }
        }

        if (!tfs_selected) {
            errors += "No specific JASPAR CORE profiles were selected\n";
        }
    }    

    v = parseFloat(f.threshold.value);
    if (isNaN(v)) {
        errors += "TFBS matrix score threshold is not a valid number\n";
    } else if (v < [%db_info.min_threshold*100%]) {
        errors += "TFBS matrix score threshold is less than the minimum of [%db_info.min_threshold*100%]\n";
    }

    if (   f.email.value == null
        || f.email.value == ""
        || isblank(f.email.value)
    ) {
        errors += "No email was provided. This is required to send notification when your analyis results are ready.\n";
    }
    
    if (!errors) return true;

    msg = "_________________________________________________________\n\n";
    msg += "The analysis was not submitted due to the following problem(s).\n";
    msg += "Please correct these problem(s) and re-submit.\n";
    msg += "________________________________________________________\n\n";
    msg += errors;
    alert(msg);

    return false;
}

\$(document).ready(function() {
  \$("#t_experiment_tree")
    .jstree({
      "core" : {
        "initially_closed" : [ "0000001" ]
      },
      "checkbox" : {
        "real_checkboxes" : true,
        "real_checkboxes_names" : function(n) {
          return [("t_" + n[0].id), 1]; 
        }
      },
      "themes" : {
        "icons" : false
      },
      "plugins" : ["themes","html_data","checkbox","ui"]
    })
    .bind("loaded.jstree", function (e, data) {})

  \$("#b_experiment_tree")
    .jstree({
      "core" : {
        "initially_closed" : [ "0000001" ]
      },
      "checkbox" : {
        "real_checkboxes" : true,
        "real_checkboxes_names" : function(n) {
          return [("b_" + n[0].id), 1]; 
        }
      },
      "themes" : {
        "icons" : false
      },
      "plugins" : ["themes","html_data","checkbox","ui"]
    })
    .bind("loaded.jstree", function (e, data) {})
});

</script>

<form name="input" enctype="multipart/form-data" method="post" onSubmit="return verify(this)" target="_blank">

  <input type="hidden" name="species" value=[%species%]>

  [%IF species == 'human'%]
    [%INCLUDE sample_t_tss_names_human.html%]
    [%INCLUDE sample_b_tss_names_human.html%]
  [%ELSIF species == 'mouse'%]
    [%INCLUDE sample_t_tss_names_mouse.html%]
    [%INCLUDE sample_b_tss_names_mouse.html%]
  [%END%]

  <div class="stepPane">
    <h2>STEP 1: Select Target CAGE Data</h2>

    <div class="leftPanel">
      <h3>Select target CAGE tag clusters</h3>

      <h4>Select by FANTOM5 experiment</h4>

      Select FANTOM5 [%species%] experiment(s):
      <br>
      <br>

      <div id="t_experiment_tree" class="jstree-open">
        [%IF species == 'human'%]
          [%INCLUDE sample_ontology_human.html%]
        [%ELSIF species == 'mouse'%]
          [%INCLUDE sample_ontology_mouse.html%]
        [%END%]
      </div>
      <br>

      with raw tag count >= <input type="text" name="t_tag_count" value="[%dflt_t_tag_count%]" size="3" maxlength="4" align="right"> and tags per million (TPM) >= <input type="text" name="t_tpm" value="[%dflt_t_tpm%]" size="3" maxlength="4" align="right">
      <br>
      <br>

      <h4>OR Select specific FANTOM5 CAGE tag cluster IDs</h4>

      Paste FANTOM5 CAGE tag cluster IDs:
      <br>
      <input type="button" name="use_sample_bed" value="Use sample CAGE tag cluster IDs" onClick="{input.t_tss_names_text.value=document.getElementById('sample_t_tss_names_[%species%]').value}">
      <br>
      <textarea name="t_tss_names_text" rows=10 cols=60 wrap=SOFT"></textarea>
      <input type="button" name="clear_t_tss_names_text" value="Clear"
        onClick="{input.t_tss_names_text.value=''}">
      <br>
      <br>

      Upload a file containing a list of FANTOM5 CAGE tag cluster IDs:
      <br>
      <span class="subtext">
        <input type="file" name="t_tss_names_file" size="33">
      </span>
      <input type="button" name="clear_t_tss_names_file" value="Clear"
        onClick="{input.t_tss_names_file.value=''}">
    </div>  <!-- end leftPanel -->

    <div class="rightPanel">
      <h3>Optionally filter target CAGE tag clusters</h3>

      <h4>Filter FANTOM5 CAGE tag clusters by TSS status</h4>

      Use only CAGE tag clusters identified as TSSs
        &nbsp;<input type="checkbox" name="t_use_tss_only">
      <br>

      <h4>Filter FANTOM5 CAGE tag clusters to those associated with specific genes</h4>

      Paste gene IDs ([%IF species == 'human'%]HGNC, [%END%]EntrezGene or UniProt IDs, one ID per line):
      <br>
      <textarea name="t_gene_ids_text" rows=10 cols=60 wrap=SOFT"></textarea>
      <input type="button" name="clear_t_gene_ids" value="Clear"
        onClick="{input.t_gene_ids_text.value=''}">
      <br>
      <br>

      Upload a file of gene IDs ([%IF species == 'human'%]HGNC, [%END%]EntrezGene or UniProt IDs, one ID per line):
      <br>
      <span class="subtext">
        <input type="file" name="t_gene_ids_file" size="33">
        <input type="button" name="clear_t_gene_ids_file" value="Clear"
          onClick="{input.t_gene_ids_file.value=''}">
      </span>
      <br>
      <br>

      <h4>Filter FANTOM5 CAGE tag clusters to those which fall within a specific set of regions</h4>

      Paste regions in BED format:
      <br>
      <textarea name="t_filter_regions_text" rows=10 cols=60 wrap=SOFT"></textarea>
      <input type="button" name="clear_t_filter_regions_text" value="Clear"
        onClick="{input.t_filter_regions_text.value=''}">
      <br>
      <br>

      Upload a file containing regions in BED format:
      <br>
      <span class="subtext">
        <input type="file" name="t_filter_regions_file" size="33">
        <input type="button" name="clear_t_filter_regions_file" value="Clear"
          onClick="{input.t_filter_regions_file.value=''}">
      </span>
    </div>  <!-- end rightPanel -->
  </div>  <!-- end stepPane -->

  <div class="cf"></div>

  <br>
  <hr noshade>

  <div class="stepPane">
    <h2>STEP 2: Select Background CAGE Data</h2>

    <div class="leftPanel">
      <h3>Select background CAGE tag clusters</h3>

      <h4>Select by FANTOM5 experiment</h4>

      Select FANTOM5 [%species%] experiment(s):
      <br>
      <br>

      <div id="b_experiment_tree" class="jstree-open">
        [%IF species == 'human'%]
          [%INCLUDE sample_ontology_human.html%]
        [%ELSIF species == 'mouse'%]
          [%INCLUDE sample_ontology_mouse.html%]
        [%END%]
      </div>
      <br>

      with raw tag count >= <input type="text" name="b_tag_count" value="[%dflt_b_tag_count%]" size="3" maxlength="4" align="right"> and tags per million (TPM) >= <input type="text" name="b_tpm" value="[%dflt_b_tpm%]" size="3" maxlength="4" align="right">
      <br>
      <br>

      <h4>OR Select specific FANTOM5 tag cluster IDs</h4>

      Paste FANTOM5 tag cluster IDs:
      <br>
      <input type="button" name="use_sample_bed" value="Use sample tag cluster IDs" onClick="{input.b_tss_names_text.value=document.getElementById('sample_b_tss_names_[%species%]').value}">
      <br>
      <textarea name="b_tss_names_text" rows=10 cols=60 wrap=SOFT></textarea>
      <input type="button" name="clear_b_tss_names_text" value="Clear"
        onClick="{input.b_tss_names_text.value=''}">
      <br>
      <br>

      Upload a file containing a list of FANTOM5 tag cluster IDs:
      <br>
      <span class="subtext">
        <input type="file" name="b_tss_names_file" size="33">
      </span>
      <input type="button" name="clear_b_tss_names_file" value="Clear"
        onClick="{input.b_tss_names_file.value=''}">
    </div>  <!-- end leftPanel -->

    <div class="rightPanel">
      <h3>Optionally filter background CAGE tag clusters</h3>

      <h4>Filter FANTOM5 CAGE tag clusters by TSS status</h4>

      Use only CAGE tag clusters identified as TSSs
        &nbsp;<input type="checkbox" name="b_use_tss_only">
      <br>

      <h4>Filter FANTOM5 CAGE tag clusters to those associated with specific genes</h4>

      Paste gene IDs ([%IF species == 'human'%]HGNC, [%END%]EntrezGene or UniProt IDs, one ID per line):
      <br>
      <textarea name="b_gene_ids_text" rows=10 cols=60 wrap=SOFT"></textarea>
      <input type="button" name="clear_b_gene_ids" value="Clear"
        onClick="{input.b_gene_ids_text.value=''}">
      <br>
      <br>

      Upload a file of IDs ([%IF species == 'human'%]HGNC, [%END%]EntrezGene or UniProt IDs, one ID per line):
      <br>
      <span class="subtext">
       <input type="file" name="b_gene_ids_file" size="33">
       <input type="button" name="clear_b_gene_ids_file" value="Clear"
         onClick="{input.b_gene_ids_file.value=''}">
       </span>
      <br>
      <br>

      <h4>Filter FANTOM5 CAGE tag clusters to those which fall within a specific set of regions</h4>

      Paste regions in BED format:
      <br>
      <textarea name="b_filter_regions_text" rows=10 cols=60 wrap=SOFT"></textarea>
      <input type="button" name="clear_b_filter_regions_text" value="Clear"
        onClick="{input.b_filter_regions_text.value=''}">
      <br>
      <br>

      Upload a file containing regions in BED format:
      <br>
      <span class="subtext">
        <input type="file" name="b_filter_regions_file" size="33">
        <input type="button" name="clear_b_filter_regions_file" value="Clear"
          onClick="{input.b_filter_regions_file.value=''}">
      </span>
    </div>  <!-- end rightPanel -->
  </div>  <!-- end stepPane -->

  <div class="cf"></div>

  <br>
  <hr noshade>

  <div class="stepPane">
    <h2>STEP 3: Select transcription factor binding site profiles</h2> 

    [<a href="javascript:newWindow=window.open('[%rel_htdocs_path%]/help/help_ssa.html#select_tfbs','help','width=800,height=800,toolbar=1,location=0,directories=0,status=0,menuBar=0,scrollBars=1,resizable=1'); newWindow.focus()">HELP</a>]

    <h4>JASPAR CORE Profiles</h4>

    <!-- XXX I don't know how/why this works DJA -->
    <!-- well, don't need this anyways. already passed by input function
      kinda redundant, as both db_info and @tax_groups are passed-->
    <!--[%tax_groups = db_info.tax_group.split(",")%]-->

    [%IF num_tax_groups > 1%]
      All profiles from the following tax groups:
      <br>
      [%first_tax_group = 1%]
      [%FOREACH tax = tax_groups%]
        &nbsp;&nbsp;<input type="checkbox" name="core_tax_groups" value="[%tax%]" [%IF first_tax_group == 1%]checked[%END%]><b>[%tax%]</b>
        [%first_tax_group = 0%]
      [%END%]
      &nbsp;with a minimum specificity of&nbsp;
    [%ELSE%]
      All <b>[%tax_group_list%]</b> profiles with a minimum specificity of&nbsp;
    [%END%]
    <input type="text" name="core_min_ic" value=[%dflt_min_ic%]
      size="2" maxlength="2" align="right"> bits (min. = [%db_info.min_ic()%] bits)

    <br><br>
  
    [%IF num_tax_groups > 1%]
      select specific profiles:
    [%ELSE%]
      select specific <b>[%tax_group_list%]</b> profiles:
    [%END%]
    <br>
    <table>
      [%IF num_tax_groups > 1%]
        <tr>
        [%FOREACH tax = tax_groups%]
          [%IF core_tf_sets.$tax.size > 0%]
            <td class="table_text" align="center"><b>[%tax%]</b></td>
          [%END%]
        [%END%]
        </tr>
      [%END%]
      <tr>
      [%FOREACH tax = tax_groups%]
        [%IF core_tf_sets.$tax.size > 0%]
          [%core_tf_list = core_tf_sets.$tax.get_matrix_list('name')%]
          <td>
          <select multiple size=8 name=core_tfs>
          [%FOREACH tf = core_tf_list%]
            <option value=[%tf.ID%]>[%tf.name%]</option>
          [%END%]
          </select>
          </td>
        [%END%]
      [%END%]
      </tr>
    </table>

    <h4>OR Enter custom TFBS profiles</h4>

    Paste one or more custom TFBS profiles:
    <br>
    <textarea name="matrix_paste_text" rows=10 cols=60 wrap=SOFT"></textarea>
    <input type="button" name="clear_matrix_paste_text" value="Clear"
      onClick="{input.matrix_paste_text.value=''}">
    <br>
    <br>

    Upload a file containing one or more TFBS profiles:
    <br>
    <span class="subtext">
      <input type="file" name="matrix_upload_file" size="33">
      <input type="button" name="clear_matrix_upload_file" value="Clear"
        onClick="{input.matrix_upload_file.value=''}">
    </span>
  </div>

  <br>
  <br>
  <hr noshade>

  <div class="stepPane">
    <h2>STEP 4: Select TFBS search parameters</h2>

    [<a href="javascript:newWindow=window.open('[%rel_htdocs_path%]/help/help_ssa.html#search_tfbs','help','width=800,height=800,toolbar=1,location=0,directories=0,status=0,menuBar=0,scrollBars=1,resizable=1'); newWindow.focus()">HELP</a>]
    <br>
    <br>

    TFBS profile matrix score threshold:
    <input type="text" name="threshold" value="[%dflt_threshold%]" size="2" maxlength="3" align="right">% (min. = [%db_info.min_threshold()*100%]%)
    <br><br>
      Amount of upstream/downstream flanking sequence to search around CAGE tag clusters:
      <input type="text" name="upstream_bp" value="[%dflt_upstream_bp%]" size="4" maxlength="4" align="right"> / <input type="text" name="downstream_bp" value="[%dflt_downstream_bp%]" size="4" maxlength="4" align="right"> bp (max. = [%max_upstream_bp%] / [%max_downstream_bp%])
    <br><br>
    Number of results to return:
    <br>
    <input type="radio" name="result_type" value="top_x_results" checked> Top
    <select name="num_display_results">
      [%FOREACH num = nresults%]
        <option value=[%num%] [%IF num == dflt_nresults%]selected[%END%] onClick="{input.result_type[0].checked=true}">[%num%]</option>
      [%END%]
    </select> results
    <br>
    <input type="radio" name="result_type" value="significant_hits"> <b>OR</b> only results with <b>Z-score >= </b>
    <select name="zscore_cutoff">
      [%FOREACH cutoff = zcutoffs%]
        <option value=[%cutoff%] [%IF cutoff == dflt_zcutoff%]selected[%END%] onClick="{input.result_type[1].checked=true}">[%cutoff%]</option>
      [%END%]
    </select>
    and <b>Fisher score >= </b>
    <select name="fisher_cutoff">
      [%FOREACH cutoff = fcutoffs%]
        <option value=[%cutoff%] [%IF cutoff == dflt_fcutoff%]selected[%END%] onClick="{input.result_type[1].checked=true}">[%cutoff%]</option>
      [%END%]
    </select>
    (Default values have been chosen based on empirical studies)
    <br>
    <br>
    Sort results by:
    <br>
    <input type="radio" name="result_sort_by" value="zscore" checked>Z-score
    <input type="radio" name="result_sort_by" value="fisher_p_value">Fisher score
    <br>
    <br>
    <input type="checkbox" name="tfbs_details"> Output binding site details for each TF (checking this option will result in slightly longer processing time)
    <br>
  </div>

  <br>
  <br>
  <hr noshade>

  <br>
  <p class="text">
    Please enter your email address:
    <input type="text" name="email" value="">
  </p>

  <p class="text">
    Press the <b>Submit</b> button to perform the analysis or <b>Reset</b> to reset the analysis parameters to their default values.<br>
    Depending on parameters selected and server load, the analysis may take anywhere from a few seconds to several minutes to perform.<br>
    <br>
    <input type="submit" name="Submit" value="Submit">
    <input type="reset" name="Reset" value="Reset">
    <input type="hidden" name="rm" value="process">
    <input type="hidden" name="sid" value="[%sid%]">
  </p>
</form>
